<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Storage Manager</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <!-- Socket.IO Client -->
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
    <!-- jQuery and Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Configure Socket.IO to properly handle binary data
        window.socketIOConfig = {
            transports: ['websocket'],
            upgrade: false,
            forceNew: true,
            reconnection: true,
            reconnectionAttempts: 5,
            reconnectionDelay: 1000,
            reconnectionDelayMax: 5000,
            timeout: 20000,
            autoConnect: true
        };

        // iOS Safari detection and mobile video enhancements
        window.deviceInfo = {
            isIOS: /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream,
            isSafari: /^((?!chrome|android).)*safari/i.test(navigator.userAgent),
            isIOSSafari: false,
            isMobile: /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)
        };
        
        // More specific iOS Safari detection
        window.deviceInfo.isIOSSafari = window.deviceInfo.isIOS && window.deviceInfo.isSafari;
        
        // Enhanced video loading for mobile devices
        window.enhanceVideoElements = function() {
            const videos = document.querySelectorAll('video');
            videos.forEach(video => {
                // iOS-specific optimizations
                if (window.deviceInfo.isIOSSafari) {
                    video.setAttribute('playsinline', 'true');
                    video.setAttribute('webkit-playsinline', 'true');
                    video.setAttribute('preload', 'metadata');
                    
                    // Progressive loading strategy for iOS
                    video.addEventListener('loadstart', function() {
                        console.log('Video loading started on iOS Safari');
                    });
                    
                    video.addEventListener('error', function(e) {
                        console.error('Video error on iOS Safari:', e);
                        // Retry mechanism for iOS
                        if (this.retryCount === undefined) this.retryCount = 0;
                        if (this.retryCount < 3) {
                            this.retryCount++;
                            console.log(`Retrying video load (attempt ${this.retryCount})`);
                            setTimeout(() => {
                                this.load();
                            }, 1000 * this.retryCount);
                        }
                    });
                }
                
                // General mobile optimizations
                if (window.deviceInfo.isMobile) {
                    video.addEventListener('canplay', function() {
                        console.log('Video ready to play on mobile device');
                    });
                    
                    // Optimize for slower connections
                    video.setAttribute('preload', 'metadata');
                }
            });
        };
        
        // Auto-enhance video elements when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            window.enhanceVideoElements();
            
            // Re-enhance when new content is added dynamically
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'childList') {
                        mutation.addedNodes.forEach(function(node) {
                            if (node.nodeType === 1) { // Element node
                                if (node.tagName === 'VIDEO' || node.querySelector('video')) {
                                    window.enhanceVideoElements();
                                }
                            }
                        });
                    }
                });
            });
            
            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
        });
    </script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-cloud-upload-alt mr-2"></i><span style="color: #bb86fc;">Storage</span> Manager
            </a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ml-auto">
                    {% if current_user.is_authenticated %}
                    <li class="nav-item">
                        <a class="nav-link" href="/">
                            <i class="fas fa-home mr-1"></i> Home
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/change_password">
                            <i class="fas fa-key mr-1"></i> Change Password
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/logout">
                            <i class="fas fa-sign-out-alt mr-1"></i> Logout
                        </a>
                    </li>
                    {% else %}
                    <li class="nav-item">
                        <a class="nav-link" href="/login">
                            <i class="fas fa-sign-in-alt mr-1"></i> Login
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/register">
                            <i class="fas fa-user-plus mr-1"></i> Register
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>
    
    <div class="main-content">
        {% block content %}{% endblock %}
    </div>

    <!-- Modal Overlay for Lightbox -->
    <div id="mediaModal" class="modal-overlay" style="display: none;" aria-hidden="true" role="dialog" aria-labelledby="modalTitle" aria-describedby="modalContent">
        <div class="modal-container">
            <div class="modal-header">
                <h4 id="modalTitle" class="modal-title">Media Viewer</h4>
                <button id="modalClose" class="modal-close" aria-label="Close modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="modalContent">
                <div class="modal-loading" id="modalLoading">
                    <div class="loading-spinner">
                        <i class="fas fa-spinner fa-spin"></i>
                    </div>
                    <p>Loading content...</p>
                </div>
                <div class="modal-media-container" id="modalMediaContainer"></div>
                <div class="modal-pdf-error" id="modalPdfError" style="display: none;">
                    <div class="pdf-error-content">
                        <i class="fas fa-exclamation-triangle" style="font-size: 3em; color: #cf6679; margin-bottom: 20px;"></i>
                        <h4>PDF Loading Failed</h4>
                        <p>This PDF cannot be displayed in your browser.</p>
                        <div class="pdf-error-actions">
                            <a href="#" id="pdfDownloadLink" class="btn btn-primary" target="_blank">
                                <i class="fas fa-download mr-2"></i>Download PDF
                            </a>
                            <a href="#" id="pdfOpenLink" class="btn btn-success ml-2" target="_blank">
                                <i class="fas fa-external-link-alt mr-2"></i>Open in New Tab
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer" id="modalFooter">
                <div class="modal-info" id="modalInfo">
                    <span class="modal-filename" id="modalFilename"></span>
                    <span class="modal-filesize" id="modalFilesize"></span>
                    <span class="modal-filetype" id="modalFiletype"></span>
                </div>
                <div class="modal-navigation" id="modalNavigation" style="display: none;">
                    <button id="modalPrev" class="modal-nav-btn" aria-label="Previous media">
                        <i class="fas fa-chevron-left"></i> Previous
                    </button>
                    <button id="modalNext" class="modal-nav-btn" aria-label="Next media">
                        Next <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <footer class="footer mt-5">
        <div class="container">
            <p class="text-muted text-center">Â© 2025 Storage Manager</p>
        </div>
    </footer>
    
    {% block scripts %}{% endblock %}
    
    <!-- Modal Lightbox System -->
    <script src="{{ url_for('static', filename='modal-lightbox.js') }}"></script>
</body>
</html>