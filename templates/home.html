{% extends "base.html" %}

{% block content %}
<div class="container">
    <h1>Upload Files</h1>
    <!-- Message container for notifications (will be filled dynamically) -->
    <div id="messageContainer"></div>
    <form id="uploadForm" method="post" enctype="multipart/form-data">
        <div class="form-group">
            <label for="fileInput">Select File:</label>
            <input type="file" id="fileInput" name="file" required>
        </div>
        <button type="submit" id="uploadButton" class="btn btn-primary">Upload</button>
    </form>

    <div id="progressBarContainer" style="display: none; margin-top: 20px; width: 100%; background-color: #f3f3f3; border-radius: 5px; padding: 3px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
        <div id="progressBar" style="width: 0%; height: 24px; background-color: #4CAF50; border-radius: 4px; text-align: center; line-height: 24px; color: white; transition: width 0.3s;">
            <span id="progressText" style="font-weight: bold;">0%</span>
        </div>
    </div>
    <p id="progressSubText" style="text-align: center; font-size: 0.9em; color: #666;"></p>


    <h2 style="margin-top: 40px;">Your Files</h2>
    <div id="files-container">
        <!-- Files will be loaded here via JavaScript or directly from Flask context -->
        {% if files %}
        <table class="table">
            <thead>
                <tr>
                    <th>Filename</th>
                    <th>Size</th>
                    <th>Public Link</th>
                    <th>Public Access</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for file in files %}
                <tr data-file-id="{{ file.id }}" data-file-hash="{{ file.file_hash }}">
                    <td>{{ file.name }}</td>
                    <td class="filesize-cell">{{ file.size | format_bytes }}</td>
                    <td>
                        {% if file.file_hash %}
                        <a href="{{ url_for('download_by_hash', salted_sha512_hash=file.file_hash) }}" target="_blank"
                            class="public-link">
                            {{ request.url_root }}d/{{ file.file_hash[:10] }}...
                        </a>
                        {% else %}
                        N/A
                        {% endif %}
                    </td>
                    <td>
                        <label class="switch">
                            <input type="checkbox" class="public-toggle" {% if file.is_public %}checked{% endif %}>
                            <span class="slider round"></span>
                        </label>
                    </td>
                    <td>
                        <a href="{{ url_for('download_by_hash', salted_sha512_hash=file.file_hash) }}"
                            class="btn btn-primary btn-sm">Download</a>
                        <button class="btn btn-danger btn-sm delete-btn" data-file-id="{{ file.id }}">Delete</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p>No files found.</p>
        {% endif %}
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.js"></script>
<script src="{{ url_for('static', filename='upload.js') }}"></script>

<script>
    // Initialize socket connection
    const socket = io();
    
    // Set up event handlers when DOM is fully loaded
    document.addEventListener('DOMContentLoaded', function() {
        // Form submission handling
        const uploadForm = document.getElementById('uploadForm');
        if (uploadForm) {
            uploadForm.addEventListener('submit', function(event) {
                event.preventDefault();
                uploadFile();
            });
        }
        
        // Socket event handlers for upload progress
        socket.on('upload_progress', function(data) {
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const progressSubText = document.getElementById('progressSubText');
            
            if (progressBar && data.percentage !== undefined) {
                const percentage = Math.min(data.percentage, 95); // Cap at 95% until finalization
                progressBar.style.width = percentage + '%';
                progressText.textContent = percentage.toFixed(0) + '%';
                
                if (data.bytes_uploaded !== undefined && data.total_bytes !== undefined) {
                    const uploadedFormatted = formatFileSize(data.bytes_uploaded);
                    const totalFormatted = formatFileSize(data.total_bytes);
                    progressSubText.textContent = `${uploadedFormatted} / ${totalFormatted}`;
                }
            }
        });
        
        socket.on('upload_complete', function(data) {
            updateProgressBar(100, 'Upload complete');
            showStatus(`File uploaded successfully. ID: ${data.file_id}`, 'success');
            
            // Refresh file list
            setTimeout(loadFiles, 1500);
        });
        
        // Add event handlers for delete buttons
        document.querySelectorAll('.delete-btn').forEach(button => {
            button.addEventListener('click', async function() {
                const fileId = this.dataset.fileId;
                const fileHash = this.closest('tr').dataset.fileHash;
                
                if (!confirm('Are you sure you want to delete this file?')) {
                    return;
                }
                
                try {
                    const response = await fetch('/delete_file', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ 
                            file_id: fileId, 
                            file_hash: fileHash 
                        })
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Failed to delete file');
                    }
                    
                    const responseData = await response.json();
                    if (responseData.status === 'success') {
                        this.closest('tr').remove();
                        showStatus('File deleted successfully', 'success');
                    } else {
                        showStatus(responseData.error || 'Failed to delete file', 'error');
                    }
                    
                } catch (error) {
                    console.error('Delete Error:', error);
                    showStatus('Error deleting file: ' + error.message, 'error');
                }
            });
        });
        
        // Add event handlers for public toggles
        document.querySelectorAll('.public-toggle').forEach(toggle => {
            toggle.addEventListener('change', async function() {
                const row = this.closest('tr');
                const fileId = row.dataset.fileId;
                const fileHash = row.dataset.fileHash;
                const isPublic = this.checked;
                
                try {
                    const response = await fetch('/toggle_public_access', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            file_id: fileId,
                            is_public: isPublic,
                            salted_sha512_hash: fileHash
                        })
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Failed to update public status');
                    }
                    
                    const responseData = await response.json();
                    if (responseData.status === 'success') {
                        showStatus(`File is now ${isPublic ? 'public' : 'private'}`, 'success');
                    } else {
                        // Revert toggle if update failed
                        this.checked = !isPublic;
                        showStatus(responseData.error || 'Failed to update public status', 'error');
                    }
                    
                } catch (error) {
                    console.error('Toggle Public Access Error:', error);
                    this.checked = !isPublic; // Revert toggle on error
                    showStatus('Error updating public status: ' + error.message, 'error');
                }
            });
        });
    });
</script>

<style>
    /* Basic Switch Styles */
    .switch {
        position: relative;
        display: inline-block;
        width: 40px;
        height: 20px;
    }

    .switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        -webkit-transition: .4s;
        transition: .4s;
        border-radius: 20px;
        /* Make it round */
    }

    .slider:before {
        position: absolute;
        content: "";
        height: 16px;
        width: 16px;
        left: 2px;
        bottom: 2px;
        background-color: white;
        -webkit-transition: .4s;
        transition: .4s;
        border-radius: 50%;
        /* Make it round */
    }

    input:checked+.slider {
        background-color: #2196F3;
    }

    input:focus+.slider {
        box-shadow: 0 0 1px #2196F3;
    }

    input:checked+.slider:before {
        -webkit-transform: translateX(20px);
        -ms-transform: translateX(20px);
        transform: translateX(20px);
    }
</style>
{% endblock %}